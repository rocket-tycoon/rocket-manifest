openapi: 3.1.0
info:
  title: Manifest API
  description: |
    Living feature documentation server for AI-assisted development.

    Manifest tracks **features** (system capabilities) rather than work items.
    Features are living descriptions that evolve with the codebase, organized in a
    hierarchical tree structure under projects.

    ## Core Concepts

    - **Project**: Groups features, directories, and git remotes for a codebase
    - **Feature**: A capability of the system, organized hierarchically
    - **Session**: A work session on a leaf feature (only one active per feature)
    - **Task**: Work unit within a session, assigned to an AI agent (can have sub-tasks)
    - **History**: Append-only log of implementation sessions
  version: 0.1.0
  license:
    name: MIT
  contact:
    name: Manifest

servers:
  - url: http://localhost:17010/api/v1
    description: Local development server

tags:
  - name: Projects
    description: Project management - groups features and directories
  - name: Directories
    description: Project directory management
  - name: Features
    description: Feature tree management
  - name: Sessions
    description: Work session management (on leaf features only)
  - name: Tasks
    description: Task management within sessions
  - name: Health
    description: Server health checks

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      operationId: health
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  # ============================================================
  # Projects
  # ============================================================
  /projects:
    get:
      tags: [Projects]
      summary: List all projects
      operationId: listProjects
      responses:
        '200':
          description: List of projects ordered by name
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Project'
    post:
      tags: [Projects]
      summary: Create a new project
      operationId: createProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProjectInput'
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/by-directory:
    get:
      tags: [Projects]
      summary: Find project by directory path
      description: |
        Given a directory path, finds the project that contains it.
        Matches if the path equals or is a subdirectory of any project directory.
        Useful for MCP clients to discover project context from the current working directory.
      operationId: getProjectByDirectory
      parameters:
        - name: path
          in: query
          required: true
          schema:
            type: string
          description: Absolute directory path to look up
          example: "/Users/dev/projects/my-app/src"
      responses:
        '200':
          description: Project with directories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectWithDirectories'
        '404':
          description: No project found for the given directory
          content:
            text/plain:
              schema:
                type: string
                example: "No project found for directory: /Users/dev/unknown"

  /projects/{id}:
    parameters:
      - $ref: '#/components/parameters/ProjectId'
    get:
      tags: [Projects]
      summary: Get a project with its directories
      operationId: getProject
      responses:
        '200':
          description: Project with directories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectWithDirectories'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags: [Projects]
      summary: Update a project
      operationId: updateProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProjectInput'
      responses:
        '200':
          description: Project updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Projects]
      summary: Delete a project
      description: Deletes the project and cascades to all features, sessions, and tasks
      operationId: deleteProject
      responses:
        '204':
          description: Project deleted
        '404':
          $ref: '#/components/responses/NotFound'

  /projects/{id}/directories:
    parameters:
      - $ref: '#/components/parameters/ProjectId'
    get:
      tags: [Directories]
      summary: List project directories
      operationId: listProjectDirectories
      responses:
        '200':
          description: List of directories (primary first, then by path)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProjectDirectory'
    post:
      tags: [Directories]
      summary: Add a directory to a project
      operationId: addProjectDirectory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddDirectoryInput'
      responses:
        '201':
          description: Directory added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectDirectory'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{id}/features:
    parameters:
      - $ref: '#/components/parameters/ProjectId'
    get:
      tags: [Features]
      summary: List all features in a project
      description: |
        Returns feature summaries ordered by priority then title.
        Always returns summaries only - use GET /features/{id} for full details.
      operationId: listProjectFeatures
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: Feature summaries in the project
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FeatureSummary'
    post:
      tags: [Features]
      summary: Create a feature in a project
      operationId: createFeature
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFeatureInput'
      responses:
        '201':
          description: Feature created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Feature'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{id}/features/bulk:
    parameters:
      - $ref: '#/components/parameters/ProjectId'
    post:
      tags: [Features]
      summary: Bulk create features with hierarchical structure
      description: |
        Create multiple features at once, supporting hierarchical relationships.
        Use this to set up an entire feature tree in one operation.

        When `confirm=false` (default), returns the proposed features without creating them.
        This allows reviewing the structure before committing.

        When `confirm=true`, creates all features and returns their IDs.
        Children are created after their parents, maintaining the tree structure.
      operationId: bulkCreateFeatures
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkCreateFeaturesInput'
      responses:
        '200':
          description: Proposed or created features
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanFeaturesResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{id}/features/roots:
    parameters:
      - $ref: '#/components/parameters/ProjectId'
    get:
      tags: [Features]
      summary: List root features (no parent) in a project
      operationId: listRootFeatures
      responses:
        '200':
          description: Root features ordered by title
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Feature'

  /projects/{id}/features/tree:
    parameters:
      - $ref: '#/components/parameters/ProjectId'
    get:
      tags: [Features]
      summary: Get complete feature tree
      description: |
        Returns all features in a hierarchical tree structure with children
        recursively nested. Useful for visualizing the full project structure.
      operationId: getFeatureTree
      responses:
        '200':
          description: Feature tree with nested children
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FeatureTreeNode'

  # ============================================================
  # Directories (standalone)
  # ============================================================
  /directories/{id}:
    parameters:
      - $ref: '#/components/parameters/DirectoryId'
    delete:
      tags: [Directories]
      summary: Remove a directory
      operationId: removeProjectDirectory
      responses:
        '204':
          description: Directory removed
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================================
  # Features (standalone)
  # ============================================================
  /features:
    get:
      tags: [Features]
      summary: List all features across all projects
      description: |
        Returns feature summaries ordered by priority then title.
        Always returns summaries only - use GET /features/{id} for full details.
      operationId: listFeatures
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: Feature summaries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FeatureSummary'

  /features/search:
    get:
      tags: [Features]
      summary: Search features by title or content
      description: |
        Search features by matching against title and details.
        Returns summaries ranked by relevance (title matches first).
        Use GET /features/{id} for full details of a specific result.
      operationId: searchFeatures
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search term to match against title and details
        - name: project_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional project UUID to limit search to
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 10
          description: Maximum number of results to return. Defaults to 10.
      responses:
        '200':
          description: Feature summaries matching the search query, ranked by relevance
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FeatureSummary'

  /features/{id}:
    parameters:
      - $ref: '#/components/parameters/FeatureId'
    get:
      tags: [Features]
      summary: Get a feature by ID
      operationId: getFeature
      responses:
        '200':
          description: The feature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Feature'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags: [Features]
      summary: Update a feature
      operationId: updateFeature
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateFeatureInput'
      responses:
        '200':
          description: Feature updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Feature'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Features]
      summary: Delete a feature
      description: Deletes the feature and cascades to all children
      operationId: deleteFeature
      responses:
        '204':
          description: Feature deleted
        '404':
          $ref: '#/components/responses/NotFound'

  /features/{id}/children:
    parameters:
      - $ref: '#/components/parameters/FeatureId'
    get:
      tags: [Features]
      summary: List direct children of a feature
      operationId: listChildren
      responses:
        '200':
          description: Direct children ordered by title
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Feature'

  /features/{id}/history:
    parameters:
      - $ref: '#/components/parameters/FeatureId'
    get:
      tags: [Features]
      summary: Get feature history
      description: Returns the implementation history log (like git log)
      operationId: getFeatureHistory
      responses:
        '200':
          description: History entries in reverse chronological order
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FeatureHistory'

  /features/{id}/diff:
    parameters:
      - $ref: '#/components/parameters/FeatureId'
    get:
      tags: [Features]
      summary: Get feature diff
      description: |
        Returns the diff between current details and desired details.
        Use this to see what changes are pending before implementation.
      operationId: getFeatureDiff
      responses:
        '200':
          description: Diff between current and desired state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureDiff'
        '404':
          $ref: '#/components/responses/NotFound'

  /features/{id}/sessions:
    parameters:
      - $ref: '#/components/parameters/FeatureId'
    get:
      tags: [Features]
      summary: List sessions for a feature
      description: Returns all sessions (active and completed) for this feature, ordered by creation date (newest first)
      operationId: listFeatureSessions
      responses:
        '200':
          description: List of sessions for the feature
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Session'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      tags: [Sessions]
      summary: Create a session on a feature (RESTful)
      description: |
        Creates a work session on a leaf feature. This is a RESTful alternative to
        `POST /sessions` where the feature ID comes from the URL path instead of the request body.
        Only leaf features (those without children) can have sessions.
        Only one active session per feature is allowed.
      operationId: createFeatureSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFeatureSessionInput'
      responses:
        '201':
          description: Session created with tasks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          description: Feature is not a leaf or already has active session
          content:
            application/json:
              schema:
                type: string

  # ============================================================
  # Sessions
  # ============================================================
  /sessions:
    post:
      tags: [Sessions]
      summary: Create a new session
      description: |
        Creates a work session on a leaf feature. Only leaf features (those without children)
        can have sessions. Only one active session per feature is allowed.
      operationId: createSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionInput'
      responses:
        '201':
          description: Session created with tasks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '500':
          description: Feature is not a leaf or already has active session
          content:
            application/json:
              schema:
                type: string

  /sessions/{id}:
    parameters:
      - $ref: '#/components/parameters/SessionId'
    get:
      tags: [Sessions]
      summary: Get a session by ID
      operationId: getSession
      responses:
        '200':
          description: The session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
        '404':
          $ref: '#/components/responses/NotFound'

  /sessions/{id}/status:
    parameters:
      - $ref: '#/components/parameters/SessionId'
    get:
      tags: [Sessions]
      summary: Get session status with task details
      operationId: getSessionStatus
      responses:
        '200':
          description: Session status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionStatusResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /sessions/{id}/complete:
    parameters:
      - $ref: '#/components/parameters/SessionId'
    post:
      tags: [Sessions]
      summary: Complete a session
      description: |
        Completes the session, creates a history entry, and deletes all tasks.
        The session is marked as completed and cannot be modified further.
        Optionally updates the feature's state (e.g., to 'implemented').
      operationId: completeSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompleteSessionInput'
      responses:
        '200':
          description: Session completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionCompletionResult'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          description: Session already completed
          content:
            application/json:
              schema:
                type: string

  /sessions/{id}/tasks:
    parameters:
      - $ref: '#/components/parameters/SessionId'
    get:
      tags: [Sessions]
      summary: List tasks in a session
      description: Returns all tasks belonging to this session
      operationId: listSessionTasks
      responses:
        '200':
          description: List of tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Task'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      tags: [Sessions]
      summary: Create a task in a session
      description: Adds a new task to an active session
      operationId: createSessionTask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTaskInput'
      responses:
        '201':
          description: Task created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          description: Session is not active
          content:
            application/json:
              schema:
                type: string

  # ============================================================
  # Tasks
  # ============================================================
  /tasks/{id}:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    get:
      tags: [Tasks]
      summary: Get a task by ID
      operationId: getTask
      responses:
        '200':
          description: The task
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags: [Tasks]
      summary: Update a task
      operationId: updateTask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTaskInput'
      responses:
        '200':
          description: Task updated
        '404':
          $ref: '#/components/responses/NotFound'

components:
  parameters:
    ProjectId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Project UUID

    DirectoryId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Directory UUID

    FeatureId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Feature UUID

    SessionId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Session UUID

    TaskId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Task UUID

    Limit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
      description: Maximum number of items to return.

    Offset:
      name: offset
      in: query
      required: false
      schema:
        type: integer
        minimum: 0
        default: 0
      description: Number of items to skip for pagination.

  responses:
    NotFound:
      description: Resource not found
      content:
        text/plain:
          schema:
            type: string
            example: "Project not found"

    InternalError:
      description: Internal server error
      content:
        text/plain:
          schema:
            type: string

  schemas:
    # ============================================================
    # Project schemas
    # ============================================================
    Project:
      type: object
      required: [id, name, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "Manifest"
        description:
          type: string
          nullable: true
          example: "Living feature documentation server"
        instructions:
          type: string
          nullable: true
          description: Project-wide instructions for AI agents (coding guidelines, conventions, etc.)
          example: "Use Result<T,E> for errors. Follow coding-guidelines.md."
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateProjectInput:
      type: object
      required: [name]
      properties:
        name:
          type: string
          example: "My Project"
        description:
          type: string
          nullable: true
        instructions:
          type: string
          nullable: true
          description: Project-wide instructions for AI agents

    UpdateProjectInput:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
          nullable: true
        instructions:
          type: string
          nullable: true
          description: Project-wide instructions for AI agents

    ProjectDirectory:
      type: object
      required: [id, project_id, path, is_primary, created_at]
      properties:
        id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        path:
          type: string
          example: "/Users/dev/projects/my-project"
        git_remote:
          type: string
          nullable: true
          example: "git@github.com:org/repo.git"
        is_primary:
          type: boolean
          default: false
        instructions:
          type: string
          nullable: true
          description: Directory-specific instructions for AI agents (build commands, test commands, etc.)
          example: "Run tests with: cargo test. Build with: cargo build --release"
        created_at:
          type: string
          format: date-time

    AddDirectoryInput:
      type: object
      required: [path]
      properties:
        path:
          type: string
          example: "/Users/dev/projects/my-project"
        git_remote:
          type: string
          nullable: true
        is_primary:
          type: boolean
          default: false
        instructions:
          type: string
          nullable: true
          description: Directory-specific instructions for AI agents

    ProjectWithDirectories:
      type: object
      required: [id, name, created_at, updated_at, directories]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        instructions:
          type: string
          nullable: true
          description: Project-wide instructions for AI agents
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        directories:
          type: array
          items:
            $ref: '#/components/schemas/ProjectDirectory'

    # ============================================================
    # Feature schemas
    # ============================================================
    Feature:
      type: object
      required: [id, project_id, title, state, priority, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        parent_id:
          type: string
          format: uuid
          nullable: true
          description: Parent feature ID (null for root features)
        title:
          type: string
          example: "User Authentication"
        details:
          type: string
          nullable: true
          description: Current feature specification (what the feature IS)
        desired_details:
          type: string
          nullable: true
          description: Desired feature specification (what the feature SHOULD be). Non-null indicates pending changes.
        state:
          $ref: '#/components/schemas/FeatureState'
        priority:
          type: integer
          default: 0
          description: Priority for ordering within parent (lower values first)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    FeatureState:
      type: string
      enum: [proposed, specified, implemented, deprecated]
      description: |
        - proposed: Initial state, idea captured
        - specified: Requirements defined
        - implemented: Feature is live in codebase
        - deprecated: Feature marked for removal

    FeatureSummary:
      type: object
      description: Lightweight feature summary without details (used for list operations)
      required: [id, project_id, title, state, priority]
      properties:
        id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        parent_id:
          type: string
          format: uuid
          nullable: true
          description: Parent feature ID (null for root features)
        title:
          type: string
          example: "User Authentication"
        state:
          $ref: '#/components/schemas/FeatureState'
        priority:
          type: integer
          default: 0
          description: Priority for ordering within parent (lower values first)

    CreateFeatureInput:
      type: object
      required: [title]
      properties:
        parent_id:
          type: string
          format: uuid
          nullable: true
        title:
          type: string
        details:
          type: string
          nullable: true
          description: Feature specification including user stories, implementation notes, and technical context
        state:
          $ref: '#/components/schemas/FeatureState'

    UpdateFeatureInput:
      type: object
      properties:
        title:
          type: string
        details:
          type: string
          nullable: true
          description: Current feature specification (what the feature IS)
        desired_details:
          type: string
          nullable: true
          description: Desired feature specification (what the feature SHOULD be). Set to plan pending changes.
        state:
          $ref: '#/components/schemas/FeatureState'
        priority:
          type: integer
          description: Priority for ordering within parent

    BulkCreateFeaturesInput:
      type: object
      required: [features]
      description: Input for bulk feature creation with hierarchical structure
      properties:
        features:
          type: array
          description: The proposed feature tree to create
          items:
            $ref: '#/components/schemas/ProposedFeature'
        confirm:
          type: boolean
          default: false
          description: |
            If true, creates the features in the database.
            If false (default), returns the proposal for review without creating anything.

    ProposedFeature:
      type: object
      required: [title]
      description: A feature proposal for bulk creation, supporting hierarchical structure
      properties:
        title:
          type: string
          description: Short capability name (2-5 words). What users can DO.
          example: "User Authentication"
        details:
          type: string
          nullable: true
          description: |
            Feature details including user stories, implementation notes, and technical context.
            User stories can use "As a [user], I can [capability] so that [benefit]" format.
        priority:
          type: integer
          default: 0
          description: Priority for ordering. Lower values = implement first.
        children:
          type: array
          default: []
          description: Child features (for hierarchical structure)
          items:
            $ref: '#/components/schemas/ProposedFeature'

    PlanFeaturesResponse:
      type: object
      required: [proposed_features, created]
      description: Response from bulk feature creation
      properties:
        proposed_features:
          type: array
          description: The proposed feature tree (same as input, for review)
          items:
            $ref: '#/components/schemas/ProposedFeature'
        created:
          type: boolean
          description: Whether the features were created (true if confirm=true was passed)
        created_feature_ids:
          type: array
          default: []
          description: UUIDs of created features (only populated if created=true)
          items:
            type: string
            format: uuid

    FeatureTreeNode:
      type: object
      description: A feature with its children recursively nested
      allOf:
        - $ref: '#/components/schemas/Feature'
        - type: object
          required: [children]
          properties:
            children:
              type: array
              items:
                $ref: '#/components/schemas/FeatureTreeNode'

    FeatureHistory:
      type: object
      required: [id, feature_id, summary, created_at]
      description: |
        Append-only log entry recording what happened during a session.
        Similar to git log - records implementation history, not version snapshots.
      properties:
        id:
          type: string
          format: uuid
        feature_id:
          type: string
          format: uuid
        session_id:
          type: string
          format: uuid
          nullable: true
        summary:
          type: string
          description: Summary of work completed
        commits:
          type: array
          description: Git commits created during this work
          items:
            $ref: '#/components/schemas/CommitRef'
        created_at:
          type: string
          format: date-time

    FeatureDiff:
      type: object
      required: [has_changes]
      description: |
        Diff between current and desired feature details.
        Use this to see pending changes before implementation.
      properties:
        has_changes:
          type: boolean
          description: Whether there are pending changes (desired_details differs from details)
        current:
          type: string
          nullable: true
          description: Current details (what the feature IS)
        desired:
          type: string
          nullable: true
          description: Desired details (what the feature SHOULD be)

    # ============================================================
    # Session schemas
    # ============================================================
    Session:
      type: object
      required: [id, feature_id, goal, status, created_at]
      properties:
        id:
          type: string
          format: uuid
        feature_id:
          type: string
          format: uuid
        goal:
          type: string
          example: "Implement OAuth login with Google"
        status:
          $ref: '#/components/schemas/SessionStatus'
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true

    SessionStatus:
      type: string
      enum: [active, completed, failed]

    CreateSessionInput:
      type: object
      required: [feature_id, goal, tasks]
      properties:
        feature_id:
          type: string
          format: uuid
        goal:
          type: string
        tasks:
          type: array
          items:
            $ref: '#/components/schemas/CreateTaskInput'

    CreateFeatureSessionInput:
      type: object
      description: Input for creating a session via RESTful endpoint (feature_id comes from URL path)
      required: [goal]
      properties:
        goal:
          type: string
          description: High-level objective for this work session
        tasks:
          type: array
          description: Initial tasks to create with the session
          default: []
          items:
            $ref: '#/components/schemas/CreateTaskInput'

    SessionResponse:
      type: object
      required: [session, tasks]
      properties:
        session:
          $ref: '#/components/schemas/Session'
        tasks:
          type: array
          items:
            $ref: '#/components/schemas/Task'

    SessionStatusResponse:
      type: object
      required: [session, feature, tasks]
      properties:
        session:
          $ref: '#/components/schemas/Session'
        feature:
          $ref: '#/components/schemas/SessionFeatureSummary'
        tasks:
          type: array
          items:
            $ref: '#/components/schemas/Task'

    SessionFeatureSummary:
      type: object
      required: [id, title]
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string

    CompleteSessionInput:
      type: object
      required: [summary]
      properties:
        summary:
          type: string
          description: Summary of work completed in this session
        commits:
          type: array
          description: Git commits created during this session
          items:
            $ref: '#/components/schemas/CommitRef'
        feature_state:
          $ref: '#/components/schemas/FeatureState'
          description: Optionally update the feature's state (e.g., to 'implemented')

    CommitRef:
      type: object
      required: [sha, message]
      description: Reference to a git commit
      properties:
        sha:
          type: string
          description: Commit SHA (short or full)
          example: "abc123f"
        message:
          type: string
          description: Commit message (first line)
          example: "Add OAuth login flow"
        author:
          type: string
          nullable: true
          description: Commit author (if different from default)

    SessionCompletionResult:
      type: object
      required: [session, history_entry]
      properties:
        session:
          $ref: '#/components/schemas/Session'
        history_entry:
          $ref: '#/components/schemas/FeatureHistory'

    # ============================================================
    # Task schemas
    # ============================================================
    Task:
      type: object
      required: [id, session_id, title, scope, status, agent_type, created_at]
      properties:
        id:
          type: string
          format: uuid
        session_id:
          type: string
          format: uuid
        parent_id:
          type: string
          format: uuid
          nullable: true
          description: Parent task ID for sub-tasks (null for top-level tasks)
        title:
          type: string
        scope:
          type: string
          description: Scope description for the agent
        status:
          $ref: '#/components/schemas/TaskStatus'
        agent_type:
          $ref: '#/components/schemas/AgentType'
        worktree_path:
          type: string
          nullable: true
          description: Git worktree path for isolated work
        branch:
          type: string
          nullable: true
          description: Git branch name
        created_at:
          type: string
          format: date-time

    TaskStatus:
      type: string
      enum: [pending, running, completed, failed]

    AgentType:
      type: string
      enum: [claude, gemini, codex]

    CreateTaskInput:
      type: object
      required: [title, scope, agent_type]
      properties:
        parent_id:
          type: string
          format: uuid
          nullable: true
          description: Parent task ID for creating sub-tasks
        title:
          type: string
        scope:
          type: string
        agent_type:
          $ref: '#/components/schemas/AgentType'

    UpdateTaskInput:
      type: object
      properties:
        status:
          $ref: '#/components/schemas/TaskStatus'
        worktree_path:
          type: string
          nullable: true
        branch:
          type: string
          nullable: true
